openapi: 3.0.0
info:
  title: WhatsApp API Server
  description: API for managing WhatsApp connections, sending messages, and more.
  version: 1.0.0

servers:
  - url: http://localhost:3000/api
    description: Local development server

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  schemas:
    Error:
      type: object
      properties:
        status:
          type: boolean
          example: false
        message:
          type: string
          example: Error message
        error:
          type: string
          example: Detailed error description

    Status:
      type: object
      properties:
        status:
          type: boolean
          example: true

    Session:
      type: object
      properties:
        id:
          type: string
          example: user1
        status:
          type: string
          enum: [connecting, open, closed]
          example: open
        qr:
          type: string
          nullable: true
          example: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA..."

paths:
  # SESSION MANAGEMENT
  /session:
    post:
      summary: Create a new WhatsApp session
      description: Creates a new WhatsApp session or retrieves an existing one with the given ID
      tags:
        - Session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sessionId:
                  type: string
                  example: user1
              required:
                - sessionId
      responses:
        200:
          description: Session created or restored successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Session created or restored successfully
                      session:
                        $ref: "#/components/schemas/Session"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # AUTO REPLY
  /auto-reply/{sessionId}:
    get:
      summary: Get auto-reply configuration for a session
      description: Retrieves the current auto-reply configuration for the specified session
      tags:
        - Auto Reply
      security:
        - ApiKeyAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: ID of the session to get auto-reply configuration for
      responses:
        200:
          description: Auto-reply configuration
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      config:
                        type: object
                        properties:
                          enabled:
                            type: boolean
                            example: true
                          rules:
                            type: array
                            items:
                              type: object
                              properties:
                                id:
                                  type: string
                                  example: "rule_1234567890"
                                type:
                                  type: string
                                  enum: [text, pattern, media]
                                  example: "text"
                                trigger:
                                  type: string
                                  example: "hello"
                                response:
                                  type: object
                                  properties:
                                    type:
                                      type: string
                                      enum: [text, image, template]
                                      example: "text"
                                    content:
                                      oneOf:
                                        - type: string
                                        - type: object
                                      example: "Hi there! How can I help you today?"
                                enabled:
                                  type: boolean
                                  example: true
                                matchCase:
                                  type: boolean
                                  example: false
                                probability:
                                  type: number
                                  minimum: 0
                                  maximum: 1
                                  example: 1
                          defaultResponse:
                            type: object
                            nullable: true
                            properties:
                              type:
                                type: string
                                enum: [text, image, template]
                                example: "text"
                              content:
                                oneOf:
                                  - type: string
                                  - type: object
                                example: "Thank you for your message. We'll get back to you soon."
                          respondToGroups:
                            type: boolean
                            example: false
                          delay:
                            type: integer
                            example: 1000
        404:
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auto-reply/config:
    post:
      summary: Update auto-reply configuration
      description: Updates the auto-reply configuration for a session
      tags:
        - Auto Reply
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionId
                - config
              properties:
                sessionId:
                  type: string
                  example: user1
                config:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      example: true
                    defaultResponse:
                      type: object
                      nullable: true
                      properties:
                        type:
                          type: string
                          enum: [text, image, template]
                          example: "text"
                        content:
                          oneOf:
                            - type: string
                            - type: object
                          example: "Thank you for your message. We'll get back to you soon."
                    respondToGroups:
                      type: boolean
                      example: false
                    delay:
                      type: integer
                      example: 1000
      responses:
        200:
          description: Auto-reply configuration updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Auto-reply configuration updated successfully
                      config:
                        type: object
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auto-reply/rule:
    post:
      summary: Add a new auto-reply rule
      description: Creates a new auto-reply rule for a session
      tags:
        - Auto Reply
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionId
                - rule
              properties:
                sessionId:
                  type: string
                  example: user1
                rule:
                  type: object
                  required:
                    - type
                    - trigger
                    - response
                  properties:
                    type:
                      type: string
                      enum: [text, pattern, media]
                      example: "text"
                    trigger:
                      type: string
                      example: "hello"
                    response:
                      type: object
                      properties:
                        type:
                          type: string
                          enum: [text, image, template]
                          example: "text"
                        content:
                          oneOf:
                            - type: string
                            - type: object
                          example: "Hi there! How can I help you today?"
                    enabled:
                      type: boolean
                      default: true
                      example: true
                    matchCase:
                      type: boolean
                      default: false
                      example: false
                    probability:
                      type: number
                      minimum: 0
                      maximum: 1
                      default: 1
                      example: 1
      responses:
        200:
          description: Auto-reply rule added
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Auto-reply rule added successfully
                      rule:
                        type: object
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      summary: Update an existing auto-reply rule
      description: Updates an existing auto-reply rule for a session
      tags:
        - Auto Reply
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionId
                - ruleId
                - updates
              properties:
                sessionId:
                  type: string
                  example: user1
                ruleId:
                  type: string
                  example: "rule_1234567890"
                updates:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      example: false
                    response:
                      type: object
                      properties:
                        type:
                          type: string
                          enum: [text, image, template]
                          example: "text"
                        content:
                          oneOf:
                            - type: string
                            - type: object
                          example: "Updated response message"
      responses:
        200:
          description: Auto-reply rule updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Auto-reply rule updated successfully
                      rule:
                        type: object
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auto-reply/{sessionId}/{ruleId}:
    delete:
      summary: Delete an auto-reply rule
      description: Deletes an auto-reply rule for a session
      tags:
        - Auto Reply
      security:
        - ApiKeyAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: ID of the session
        - name: ruleId
          in: path
          required: true
          schema:
            type: string
          description: ID of the rule to delete
      responses:
        200:
          description: Auto-reply rule deleted
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Auto-reply rule deleted successfully
        404:
          description: Rule not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # BULK MESSAGING
  /bulk-message/send:
    post:
      summary: Send a bulk message to multiple recipients
      description: Sends the same message to multiple recipients with tracking
      tags:
        - Bulk Messaging
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionId
                - recipients
                - message
              properties:
                sessionId:
                  type: string
                  example: user1
                  description: ID of the session to use for sending
                recipients:
                  type: array
                  items:
                    type: string
                  example: ["628123456789", "628987654321", "628123987456"]
                  description: List of phone numbers to send the message to
                message:
                  type: object
                  required:
                    - type
                    - content
                  properties:
                    type:
                      type: string
                      enum: [text, template, image, document]
                      example: "text"
                      description: Type of message to send
                    content:
                      oneOf:
                        - type: string
                        - type: object
                      example: "Hello! This is a bulk message sent to multiple recipients."
                      description: Content of the message
                campaignName:
                  type: string
                  example: "promotion_may2025"
                  description: Optional name for the campaign
                delay:
                  type: integer
                  default: 3000
                  example: 3000
                  description: Delay between messages in milliseconds
                useQueue:
                  type: boolean
                  default: true
                  description: Whether to use the queue system
      responses:
        200:
          description: Bulk message campaign started
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Bulk message campaign started
                      campaignId:
                        type: string
                        example: "promotion_may2025_1680123456789"
                      totalRecipients:
                        type: integer
                        example: 3
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /bulk-message/send-personalized:
    post:
      summary: Send a personalized bulk message using templates with variables
      description: Sends personalized messages to multiple recipients using templates with variable substitution
      tags:
        - Bulk Messaging
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionId
                - recipients
                - messageTemplate
              properties:
                sessionId:
                  type: string
                  example: user1
                  description: ID of the session to use for sending
                recipients:
                  type: array
                  items:
                    type: object
                    required:
                      - number
                    properties:
                      number:
                        type: string
                        example: "628123456789"
                        description: Phone number of the recipient
                      variables:
                        type: object
                        example:
                          {
                            "name": "John",
                            "product": "Premium Plan",
                            "discount": "30%",
                          }
                        description: Variables to use in the template
                  example:
                    [
                      {
                        "number": "628123456789",
                        "variables":
                          {
                            "name": "John",
                            "product": "Premium Plan",
                            "discount": "30%",
                          },
                      },
                      {
                        "number": "628987654321",
                        "variables":
                          {
                            "name": "Sarah",
                            "product": "Business Plan",
                            "discount": "25%",
                          },
                      },
                    ]
                  description: List of recipients with their personalization variables
                messageTemplate:
                  type: object
                  required:
                    - type
                    - content
                  properties:
                    type:
                      type: string
                      enum: [text, template]
                      example: "text"
                      description: Type of message to send
                    content:
                      oneOf:
                        - type: string
                        - type: object
                      example: "Hello {{name}}! We're offering you a special {{discount}} discount on your {{product}} subscription. Reply if you're interested!"
                      description: Template content with variables in {{variable}} format
                campaignName:
                  type: string
                  example: "personalized_offers"
                  description: Optional name for the campaign
                delay:
                  type: integer
                  default: 3000
                  example: 3000
                  description: Delay between messages in milliseconds
                useQueue:
                  type: boolean
                  default: true
                  description: Whether to use the queue system
      responses:
        200:
          description: Personalized bulk message campaign started
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Personalized bulk message campaign started
                      campaignId:
                        type: string
                        example: "personalized_offers_1680123456789"
                      totalRecipients:
                        type: integer
                        example: 2
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /bulk-message/upload-csv:
    post:
      summary: Upload a CSV file with recipients for bulk messaging
      description: Processes a CSV file containing recipient information for bulk messaging
      tags:
        - Bulk Messaging
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: CSV file with recipients (should have at least a 'number' or 'phone' column)
      responses:
        200:
          description: CSV processed successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: CSV processed successfully
                      recipients:
                        type: array
                        items:
                          type: object
                          properties:
                            number:
                              type: string
                              example: "628123456789"
                            variables:
                              type: object
                              example:
                                {
                                  "name": "John",
                                  "product": "Premium Plan",
                                  "discount": "30%",
                                }
                      count:
                        type: integer
                        example: 3
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /bulk-message/campaign/{campaignId}:
    get:
      summary: Get status of a specific campaign
      description: Returns detailed information and status about a specific bulk messaging campaign
      tags:
        - Bulk Messaging
      security:
        - ApiKeyAuth: []
      parameters:
        - name: campaignId
          in: path
          required: true
          schema:
            type: string
          description: ID of the campaign to get status for
      responses:
        200:
          description: Campaign status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      campaign:
                        type: object
                        properties:
                          id:
                            type: string
                            example: "promotion_may2025_1680123456789"
                          sessionId:
                            type: string
                            example: "user1"
                          messageType:
                            type: string
                            example: "text"
                          totalRecipients:
                            type: integer
                            example: 3
                          processedCount:
                            type: integer
                            example: 2
                          successCount:
                            type: integer
                            example: 2
                          failedCount:
                            type: integer
                            example: 0
                          startTime:
                            type: integer
                            example: 1680123456789
                          endTime:
                            type: integer
                            nullable: true
                            example: null
                          status:
                            type: string
                            enum: [processing, completed, failed, cancelled]
                            example: "processing"
                          progress:
                            type: integer
                            example: 67
        404:
          description: Campaign not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /bulk-message/campaigns/{sessionId}:
    get:
      summary: List all campaigns for a session
      description: Returns a list of all bulk messaging campaigns for a specific session
      tags:
        - Bulk Messaging
      security:
        - ApiKeyAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: ID of the session to list campaigns for
      responses:
        200:
          description: List of campaigns
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      count:
                        type: integer
                        example: 2
                      campaigns:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              example: "promotion_may2025_1680123456789"
                            messageType:
                              type: string
                              example: "text"
                            totalRecipients:
                              type: integer
                              example: 3
                            successCount:
                              type: integer
                              example: 3
                            failedCount:
                              type: integer
                              example: 0
                            startTime:
                              type: integer
                              example: 1680123456789
                            endTime:
                              type: integer
                              nullable: true
                              example: 1680123499999
                            status:
                              type: string
                              enum: [processing, completed, failed, cancelled]
                              example: "completed"
        404:
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /bulk-message/cancel:
    post:
      summary: Cancel an ongoing campaign
      description: Cancels a currently processing bulk messaging campaign
      tags:
        - Bulk Messaging
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - campaignId
              properties:
                campaignId:
                  type: string
                  example: "campaign_1234567890"
                  description: ID of the campaign to cancel
      responses:
        200:
          description: Campaign cancelled successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Campaign cancelled successfully
                      campaignId:
                        type: string
                        example: "campaign_1234567890"
        400:
          description: Bad request or campaign not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /session/{sessionId}:
    get:
      summary: Get status of a specific session
      description: Returns information about a specific WhatsApp session
      tags:
        - Session
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: ID of the session to get information for
      responses:
        200:
          description: Session information
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      session:
                        $ref: "#/components/schemas/Session"
        404:
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Delete a session and disconnect
      description: Deletes a WhatsApp session and disconnects from WhatsApp
      tags:
        - Session
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: ID of the session to delete
      responses:
        200:
          description: Session deleted successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      message:
                        type: string
                        example: Session deleted successfully
                      sessionId:
                        type: string
                        example: user1
        404:
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /session/qr/{sessionId}:
    get:
      summary: Get QR code for a session
      description: Returns the QR code for scanning with WhatsApp mobile app to authenticate a session
      tags:
        - Session
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: ID of the session to get QR code for
      responses:
        200:
          description: QR code or connection status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      qr:
                        type: string
                        nullable: true
                        example: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA..."
                        description: Base64 encoded QR code image
                      connected:
                        type: boolean
                        example: false
                        description: Whether the session is already connected
        404:
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /session/list/all:
    get:
      summary: List all active sessions
      description: Returns a list of all active WhatsApp sessions
      tags:
        - Session
      responses:
        200:
          description: List of active sessions
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      count:
                        type: integer
                        example: 2
                        description: Number of active sessions
                      sessions:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              example: user1
                            status:
                              type: string
                              example: open

  # STATUS ENDPOINTS
  /status/{sessionId}:
    get:
      summary: Get status of a specific session
      description: Returns detailed status information about a specific WhatsApp session
      tags:
        - Status
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: ID of the session to get status for
      responses:
        200:
          description: Session status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      session:
                        type: object
                        properties:
                          id:
                            type: string
                            example: user1
                          status:
                            type: string
                            example: open
                          isConnected:
                            type: boolean
                            example: true
                          hasQueuedMessages:
                            type: boolean
                            example: false
                      queue:
                        type: object
                        properties:
                          itemsInQueue:
                            type: integer
                            example: 0
                          processing:
                            type: boolean
                            example: false
                          lastProcessed:
                            type: integer
                            nullable: true
                            example: 1680123456789
                          stats:
                            type: object
                            properties:
                              total:
                                type: integer
                                example: 10
                              success:
                                type: integer
                                example: 8
                              failed:
                                type: integer
                                example: 2
        404:
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /status:
    get:
      summary: Get status of all sessions
      description: Returns status information for all active WhatsApp sessions
      tags:
        - Status
      responses:
        200:
          description: All sessions status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      count:
                        type: integer
                        example: 2
                      sessions:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              example: user1
                            status:
                              type: string
                              example: open
                            isConnected:
                              type: boolean
                              example: true

  /status/server/health:
    get:
      summary: Check server health status
      description: Returns health and performance information about the WhatsApp API server
      tags:
        - Status
      responses:
        200:
          description: Server health status
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Status"
                  - type: object
                    properties:
                      uptime:
                        type: number
                        example: 3600
                        description: Server uptime in seconds
                      timestamp:
                        type: integer
                        example: 1680123456789
                        description: Current server timestamp
                      activeSessions:
                        type: integer
                        example: 2
                        description: Number of active sessions
                      memory:
                        type: object
                        properties:
                          rss:
                            type: string
                            example: "128.5 MB"
                          heapTotal:
                            type: string
                            example: "64.2 MB"
                          heapUsed:
                            type: string
                            example: "48.7 MB"
                      version:
                        type: string
                        example: "1.0.0"
                        description: Server version

  # MESSAGING ENDPOINTS
  /message/text:
    post:
      summary: Send a text message
      description: Sends a text message to a WhatsApp contact
      tags:
        - Messages
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionId
                - to
                - text
              properties:
                sessionId:
                  type: string
                  example: user1
                  description: ID of the session to use for sending
                to:
                  type: string
                  example: "628123456789"
                  description: Phone number of the recipient
                text:
                  type: string
                  example: "Hello, this is a test message"
                  description: Content of the text message
                quotedMessageId:
                  type: string
                  example: "3EB0195D37F6"
                  description: Optional message ID to quote/reply to
                useQueue:
                  type: boolean
                  default: true
                  example: true
                  description: Whether to use the message queue
                queueOnly:
                  type: boolean
                  default: false
                  example: false
                  description: Whether to only add to queue without sending
                delay:
                  type: integer
                  default: 1000
